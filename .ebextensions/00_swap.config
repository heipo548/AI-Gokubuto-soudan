# .ebextensions/00_swap.config

commands:
  01_create_swap_file:
    # test で「ファイルが存在しない場合」に実行するので、存在チェックは test に集約
    command: "sudo fallocate -l 2G /swapfile"
    test: "test ! -f /swapfile"
  02_set_permissions:
    command: "sudo chmod 600 /swapfile"
    test: "test -f /swapfile" # 01_create_swap_file が成功した場合など
  03_mkswap:
    command: "sudo mkswap /swapfile"
    test: "test -f /swapfile && ! sudo blkid -t TYPE=swap /swapfile >/dev/null 2>&1"
  04_swapon:
    command: "sudo swapon /swapfile"
    # YAMLクォートをシングルに、grep パターンを修正
    test: 'test -f /swapfile && sudo blkid -t TYPE=swap /swapfile >/dev/null 2>&1 && ! grep -q "^/swapfile" /proc/swaps'
  05_ensure_fstab_entry: # fstab へのエントリを冪等に保証するコマンド
    # /etc/fstab に指定の行が存在しない場合のみ追記する
    command: "grep -qxF '/swapfile swap swap defaults 0 0' /etc/fstab || echo '/swapfile swap swap defaults 0 0' | sudo tee -a /etc/fstab"
    test: "test -f /swapfile" # スワップファイルが存在する場合

# files セクションは 05_ensure_fstab_entry で代替するため削除、またはコメントアウトします。
# files:
#   "/etc/fstab":
#     mode: "000644"
#     owner: root
#     group: root
#     append: true # 冪等性が低いため推奨されない
#     content: |
#       /swapfile swap swap defaults 0 0